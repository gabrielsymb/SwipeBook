generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model prestadores {
  id            String         @id @default(uuid()) @db.Uuid
  nome          String         @db.VarChar(255)
  email         String         @unique @db.VarChar(255)
  senha_hash    String         @db.VarChar(255)
  criado_em     DateTime?      @default(now()) @db.Timestamp(6)
  atualizado_em DateTime?      @default(now()) @db.Timestamp(6)
  agendamentos  agendamentos[]
  audit_logs    audit_logs[]
  clientes      clientes[]
  servicos      servicos[]
  sessions      sessions[]
}

model clientes {
  id            String         @id @default(uuid()) @db.Uuid
  prestador_id  String         @db.Uuid
  nome          String         @db.VarChar(255)
  telefone      String?        @db.VarChar(50)
  email         String?        @db.VarChar(255)
  pendencia     Boolean        @default(false)
  criado_em     DateTime?      @default(now()) @db.Timestamp(6)
  atualizado_em DateTime?      @default(now()) @db.Timestamp(6)
  ativo         Boolean        @default(true)
  deleted_at    DateTime?      @db.Timestamp(6)
  agendamentos  agendamentos[]
  prestador     prestadores    @relation(fields: [prestador_id], references: [id])

  @@index([prestador_id])
}

model servicos {
  id           String         @id @default(uuid()) @db.Uuid
  prestador_id String         @db.Uuid
  nome         String         @db.VarChar(255)
  preco        Decimal        @db.Decimal(10, 2)
  duracao_min  Int            @default(30)
  criado_em    DateTime?      @default(now()) @db.Timestamp(6)
  agendamentos agendamentos[]
  prestador    prestadores    @relation(fields: [prestador_id], references: [id])

  @@index([prestador_id])
}

model agendamentos {
  id                String            @id @default(uuid()) @db.Uuid
  prestador_id      String            @db.Uuid
  cliente_id        String?           @db.Uuid
  servico_id        String            @db.Uuid
  data_agendada     DateTime          @db.Timestamp(6)
  status            AgendamentoStatus @default(scheduled)
  payment_status    PaymentStatus     @default(unpaid)
  iniciado_em       DateTime?         @db.Timestamp(6)
  finalizado_em     DateTime?         @db.Timestamp(6)
  deleted_at        DateTime?         @db.Timestamp(6)
  criado_em         DateTime?         @default(now()) @db.Timestamp(6)
  atualizado_em     DateTime?         @default(now()) @db.Timestamp(6)
  canceled_at       DateTime?         @db.Timestamp(6)
  previous_start_at DateTime?         @db.Timestamp(6)
  real_duration_min Int?
  rescheduled_at    DateTime?         @db.Timestamp(6)
  version           Int               @default(1)
  position_key      String            @default("")
  cliente           clientes?         @relation(fields: [cliente_id], references: [id])
  prestador         prestadores       @relation(fields: [prestador_id], references: [id])
  servico           servicos          @relation(fields: [servico_id], references: [id])
  audit_logs        audit_logs[]
  session           sessions?

  @@unique([prestador_id, data_agendada, position_key], name: "agendamento_dia_ordem")
  @@index([prestador_id])
  @@index([cliente_id])
  @@index([servico_id])
  @@index([prestador_id, data_agendada])
}

model audit_logs {
  id             String        @id @default(uuid()) @db.Uuid
  prestador_id   String        @db.Uuid
  agendamento_id String?       @db.Uuid
  user_actor_id  String?       @db.Uuid
  metadata       Json?
  criado_em      DateTime?     @default(now()) @db.Timestamp(6)
  action         AuditAction
  after          Json?
  before         Json?
  entidade       String?       @db.VarChar(50)
  agendamento    agendamentos? @relation(fields: [agendamento_id], references: [id])
  prestador      prestadores   @relation(fields: [prestador_id], references: [id])

  @@index([prestador_id])
  @@index([agendamento_id])
  @@index([action])
}

model sessions {
  id                String       @id @default(uuid()) @db.Uuid
  prestador_id      String       @db.Uuid
  agendamento_id    String       @unique @db.Uuid
  started_at        DateTime     @default(now()) @db.Timestamp(6)
  last_heartbeat_at DateTime     @default(now()) @db.Timestamp(6)
  elapsed_ms        BigInt       @default(0)
  status            String       @default("active")
  stopped_at        DateTime?    @db.Timestamp(6)
  agendamento       agendamentos @relation(fields: [agendamento_id], references: [id])
  prestador         prestadores  @relation(fields: [prestador_id], references: [id])

  @@index([prestador_id, agendamento_id])
}

enum AgendamentoStatus {
  scheduled
  in_progress
  done
  canceled
  deleted
}

enum PaymentStatus {
  unpaid
  paid
  partial
  refunded
}

enum AuditAction {
  CRIACAO
  ATUALIZACAO
  STATUS_MUDOU
  REPOSICIONADO
  INICIADO
  FINALIZADO
  CANCELADO
  EXCLUIDO
  REAGENDADO
}
